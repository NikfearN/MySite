// tracker.js - –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π —Ç—Ä–µ–∫–µ—Ä –¥–ª—è Chrome
let memoryStorage = {}; // –†–µ–∑–µ—Ä–≤–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ –≤ –ø–∞–º—è—Ç–∏

function trackPageView() {
    const currentPage = window.location.pathname.split('/').pop() || 'index.html';
    const pageName = getPageName(currentPage);
    
    console.log(`üìä –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ: ${pageName}`);
    
    // –ü—Ä–æ–±—É–µ–º –≤—Å–µ –º–µ—Ç–æ–¥—ã —Ö—Ä–∞–Ω–µ–Ω–∏—è
    updateSessionStorage(pageName);
    updateLocalStorage(pageName);
    updateCookiesStorage(pageName);
    updateMemoryStorage(pageName);
    
    // –õ–æ–≥–∏—Ä—É–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
    logStorageStatus();
}

function updateSessionStorage(pageName) {
    try {
        if (typeof sessionStorage !== 'undefined') {
            let sessionHistory = JSON.parse(sessionStorage.getItem('sessionHistory')) || {};
            sessionHistory[pageName] = (sessionHistory[pageName] || 0) + 1;
            sessionStorage.setItem('sessionHistory', JSON.stringify(sessionHistory));
            console.log('‚úÖ Session Storage –æ–±–Ω–æ–≤–ª–µ–Ω');
        }
    } catch (e) {
        console.log('‚ùå Session Storage –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω');
    }
}

function updateLocalStorage(pageName) {
    try {
        if (typeof localStorage !== 'undefined') {
            let allTimeHistory = JSON.parse(localStorage.getItem('allTimeHistory')) || {};
            allTimeHistory[pageName] = (allTimeHistory[pageName] || 0) + 1;
            localStorage.setItem('allTimeHistory', JSON.stringify(allTimeHistory));
            console.log('‚úÖ Local Storage –æ–±–Ω–æ–≤–ª–µ–Ω');
        }
    } catch (e) {
        console.log('‚ùå Local Storage –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω');
    }
}

function updateCookiesStorage(pageName) {
    try {
        if (navigator.cookieEnabled) {
            let cookiesHistory = getCookiesHistory();
            cookiesHistory[pageName] = (cookiesHistory[pageName] || 0) + 1;
            setCookiesHistory(cookiesHistory);
            console.log('‚úÖ Cookies –æ–±–Ω–æ–≤–ª–µ–Ω—ã');
        }
    } catch (e) {
        console.log('‚ùå Cookies –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã');
    }
}

function updateMemoryStorage(pageName) {
    // –í—Å–µ–≥–¥–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç - —Ö—Ä–∞–Ω–∏–ª–∏—â–µ –≤ –ø–∞–º—è—Ç–∏
    memoryStorage[pageName] = (memoryStorage[pageName] || 0) + 1;
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –≥–ª–æ–±–∞–ª—å–Ω—É—é –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∏–∑ –¥—Ä—É–≥–∏—Ö —Ñ–∞–π–ª–æ–≤
    window.memoryStorage = memoryStorage;
    console.log('‚úÖ Memory Storage –æ–±–Ω–æ–≤–ª–µ–Ω');
}

function getCookiesHistory() {
    try {
        const cookieValue = getCookie('pageHistory');
        return cookieValue ? JSON.parse(cookieValue) : {};
    } catch (e) {
        return {};
    }
}

function setCookiesHistory(history) {
    try {
        const jsonString = JSON.stringify(history);
        setCookie('pageHistory', jsonString, 30); // 30 –¥–Ω–µ–π
        return true;
    } catch (e) {
        return false;
    }
}

function setCookie(name, value, days) {
    try {
        const date = new Date();
        date.setTime(date.getTime() + (days * 24 * 60 * 60 * 1000));
        const expires = "expires=" + date.toUTCString();
        document.cookie = `${name}=${encodeURIComponent(value)};${expires};path=/;SameSite=Lax`;
        return true;
    } catch (e) {
        return false;
    }
}

function getCookie(name) {
    try {
        const nameEQ = name + "=";
        const ca = document.cookie.split(';');
        for(let i = 0; i < ca.length; i++) {
            let c = ca[i].trim();
            if (c.indexOf(nameEQ) === 0) {
                return decodeURIComponent(c.substring(nameEQ.length));
            }
        }
        return null;
    } catch (e) {
        return null;
    }
}

function deleteCookie(name) {
    document.cookie = `${name}=;expires=Thu, 01 Jan 1970 00:00:00 GMT;path=/`;
}

function getPageName(pageFile) {
    const pageNames = {
        'index.html': '–ì–ª–∞–≤–Ω–∞—è',
        'about.html': '–û–±–æ –º–Ω–µ',
        'interests.html': '–ú–æ–∏ –∏–Ω—Ç–µ—Ä–µ—Å—ã',
        'study.html': '–£—á–µ–±–∞',
        'album.html': '–§–æ—Ç–æ–∞–ª—å–±–æ–º',
        'contact.html': '–ö–æ–Ω—Ç–∞–∫—Ç',
        'test.html': '–¢–µ—Å—Ç',
        'history.html': '–ò—Å—Ç–æ—Ä–∏—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞'
    };
    return pageNames[pageFile] || pageFile;
}

function getAllStorageData() {
    return {
        session: safeJSONParse(sessionStorage?.getItem('sessionHistory')),
        local: safeJSONParse(localStorage?.getItem('allTimeHistory')),
        cookies: getCookiesHistory(),
        memory: window.memoryStorage || {}
    };
}

function safeJSONParse(str) {
    try {
        return str ? JSON.parse(str) : {};
    } catch (e) {
        return {};
    }
}

function logStorageStatus() {
    const data = getAllStorageData();
    console.log('üìä –°—Ç–∞—Ç—É—Å —Ö—Ä–∞–Ω–∏–ª–∏—â:', {
        session: Object.keys(data.session).length,
        local: Object.keys(data.local).length, 
        cookies: Object.keys(data.cookies).length,
        memory: Object.keys(data.memory).length
    });
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
document.addEventListener('DOMContentLoaded', function() {
    console.log('üöÄ –°—Ç—Ä–∞–Ω–∏—Ü–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞, –∑–∞–ø—É—Å–∫ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è...');
    trackPageView();
});

// –≠–∫—Å–ø–æ—Ä—Ç –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ history.js
window.tracker = {
    trackPageView,
    getAllStorageData,
    getCookiesHistory,
    deleteCookie
};
