// history.js - –ü–æ–ª–Ω–∞—è –≤–µ—Ä—Å–∏—è —Å –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ–º –¥–∞–Ω–Ω—ã—Ö –∏–∑ Cookies
document.addEventListener('DOMContentLoaded', function() {
    console.log('üìä History page loaded');
    displayAllHistory();
    initClearButtons();
});

function displayAllHistory() {
    // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ –≤—Å–µ—Ö —Ö—Ä–∞–Ω–∏–ª–∏—â
    const allData = getAllHistoryData();
    
    console.log('üìã All history data:', allData);
    
    // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é —Ç–µ–∫—É—â–µ–≥–æ —Å–µ–∞–Ω—Å–∞ (Session Storage)
    displayTable('sessionHistory', allData.session, '–ò—Å—Ç–æ—Ä–∏—è —Ç–µ–∫—É—â–µ–≥–æ —Å–µ–∞–Ω—Å–∞ –ø—É—Å—Ç–∞');
    
    // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é –∑–∞ –≤—Å–µ –≤—Ä–µ–º—è (Local Storage)
    displayTable('allTimeHistory', allData.local, '–ò—Å—Ç–æ—Ä–∏—è –∑–∞ –≤—Å–µ –≤—Ä–µ–º—è –ø—É—Å—Ç–∞');
    
    // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é –∏–∑ Cookies
    displayTable('cookiesHistory', allData.cookies, '–ò—Å—Ç–æ—Ä–∏—è –≤ Cookies –ø—É—Å—Ç–∞');
}

function getAllHistoryData() {
    return {
        session: JSON.parse(sessionStorage.getItem('sessionHistory')) || {},
        local: JSON.parse(localStorage.getItem('allTimeHistory')) || {},
        cookies: getCookiesHistory()
    };
}

function getCookiesHistory() {
    try {
        const cookieValue = getCookie('pageHistory');
        console.log('üç™ Raw cookie value:', cookieValue);
        return cookieValue ? JSON.parse(cookieValue) : {};
    } catch (e) {
        console.error('‚ùå Error reading cookies history:', e);
        return {};
    }
}

function displayTable(tableId, history, emptyMessage) {
    const table = document.getElementById(tableId);
    if (!table) {
        console.error(`‚ùå Table ${tableId} not found`);
        return;
    }
    
    const tbody = table.querySelector('tbody');
    tbody.innerHTML = '';
    
    console.log(`üìä ${tableId}:`, history);
    
    if (Object.keys(history).length === 0) {
        const row = document.createElement('tr');
        row.innerHTML = `<td colspan="2" class="empty-history">${emptyMessage}</td>`;
        tbody.appendChild(row);
    } else {
        // –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ —É–±—ã–≤–∞–Ω–∏—é –ø–æ—Å–µ—â–µ–Ω–∏–π
        const sortedEntries = Object.entries(history).sort((a, b) => b[1] - a[1]);
        
        sortedEntries.forEach(([page, count]) => {
            const row = document.createElement('tr');
            row.innerHTML = `<td>${page}</td><td>${count}</td>`;
            tbody.appendChild(row);
        });
    }
}

function initClearButtons() {
    // –û—á–∏—Å—Ç–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏ —Å–µ–∞–Ω—Å–∞
    document.getElementById('clearSession')?.addEventListener('click', function() {
        if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –æ—á–∏—Å—Ç–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é —Ç–µ–∫—É—â–µ–≥–æ —Å–µ–∞–Ω—Å–∞?')) {
            sessionStorage.removeItem('sessionHistory');
            displayAllHistory();
            alert('–ò—Å—Ç–æ—Ä–∏—è —Ç–µ–∫—É—â–µ–≥–æ —Å–µ–∞–Ω—Å–∞ –æ—á–∏—â–µ–Ω–∞');
        }
    });
    
    // –û—á–∏—Å—Ç–∫–∞ –≤—Å–µ–π –∏—Å—Ç–æ—Ä–∏–∏
    document.getElementById('clearAll')?.addEventListener('click', function() {
        if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –æ—á–∏—Å—Ç–∏—Ç—å –≤—Å—é –∏—Å—Ç–æ—Ä–∏—é –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤?')) {
            // –û—á–∏—â–∞–µ–º –≤—Å–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞
            sessionStorage.removeItem('sessionHistory');
            localStorage.removeItem('allTimeHistory');
            deleteCookie('pageHistory');
            
            displayAllHistory();
            alert('–í—Å—è –∏—Å—Ç–æ—Ä–∏—è –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤ –æ—á–∏—â–µ–Ω–∞');
        }
    });
    
    // –û—á–∏—Å—Ç–∫–∞ —Ç–æ–ª—å–∫–æ Cookies
    document.getElementById('clearCookies')?.addEventListener('click', function() {
        if (confirm('–û—á–∏—Å—Ç–∏—Ç—å —Ç–æ–ª—å–∫–æ Cookies –∏—Å—Ç–æ—Ä–∏—é?')) {
            deleteCookie('pageHistory');
            displayAllHistory();
            alert('Cookies –∏—Å—Ç–æ—Ä–∏—è –æ—á–∏—â–µ–Ω–∞');
        }
    });
}

// –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å Cookies (–¥—É–±–ª–∏—Ä—É–µ–º –¥–ª—è –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏)
function getCookie(name) {
    const nameEQ = name + "=";
    const ca = document.cookie.split(';');
    for(let i = 0; i < ca.length; i++) {
        let c = ca[i].trim();
        if (c.indexOf(nameEQ) === 0) {
            return decodeURIComponent(c.substring(nameEQ.length));
        }
    }
    return null;
}

function setCookie(name, value, days) {
    const date = new Date();
    date.setTime(date.getTime() + (days * 24 * 60 * 60 * 1000));
    const expires = "expires=" + date.toUTCString();
    document.cookie = `${name}=${encodeURIComponent(value)};${expires};path=/`;
}

function deleteCookie(name) {
    document.cookie = `${name}=;expires=Thu, 01 Jan 1970 00:00:00 GMT;path=/`;
    console.log(`üç™ Cookie deleted: ${name}`);
}

// –£—Ç–∏–ª–∏—Ç—ã –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
function debugCookies() {
    console.log('üç™ All cookies:', document.cookie);
    console.log('üç™ PageHistory cookie:', getCookie('pageHistory'));
    console.log('üç™ Parsed cookie history:', getCookiesHistory());
}

// –ó–∞–ø—É—Å–∫–∞–µ–º –æ—Ç–ª–∞–¥–∫—É –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –∏—Å—Ç–æ—Ä–∏–∏
if (window.location.pathname.includes('history.html')) {
    setTimeout(debugCookies, 1000);
}
